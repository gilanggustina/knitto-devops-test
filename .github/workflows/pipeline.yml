name: CI-CD

on:
  push:
    branches: [ master ]
  workflow_dispatch:

env:
  REGISTRY: docker.io
  IMAGE_FE: devops-test-frontend
  IMAGE_BE: devops-test-backend
  IMAGE_DB: devops-test-db

jobs:
# =====================================================
# BUILD & PUSH IMAGE
# =====================================================
  build-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}

      # ======================
      # FRONTEND
      # ======================
      - name: Build & Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./fe
          push: true
          tags: |
            ${{ secrets.DOCKER_USER }}/${{ env.IMAGE_FE }}:latest
            ${{ secrets.DOCKER_USER }}/${{ env.IMAGE_FE }}:${{ github.sha }}
          build-args: |
            VITE_API_URL=/api
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ======================
      # BACKEND
      # ======================
      - name: Build & Push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./be
          push: true
          tags: |
            ${{ secrets.DOCKER_USER }}/${{ env.IMAGE_BE }}:latest
            ${{ secrets.DOCKER_USER }}/${{ env.IMAGE_BE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ======================
      # DATABASE
      # ======================
      - name: Build & Push Database
        uses: docker/build-push-action@v5
        with:
          context: ./db
          push: true
          tags: |
            ${{ secrets.DOCKER_USER }}/${{ env.IMAGE_DB }}:latest
            ${{ secrets.DOCKER_USER }}/${{ env.IMAGE_DB }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

# =====================================================
# DEPLOY
# =====================================================
  deploy:
    runs-on: ubuntu-latest
    needs: build-push

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh

      # ======================
      # VM-1
      # ======================
      - name: Setup SSH VM-1
        run: |
          echo "${{ secrets.SSH_VM1_PRIVATE_KEY }}" > ~/.ssh/id_vm1
          chmod 600 ~/.ssh/id_vm1
          ssh-keyscan -p ${{ secrets.SSH_VM1_PORT }} \
            ${{ secrets.SSH_VM1_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VM-1
        run: |
          ssh -i ~/.ssh/id_vm1 \
            -p ${{ secrets.SSH_VM1_PORT }} \
            ${{ secrets.SSH_VM1_USER }}@${{ secrets.SSH_VM1_HOST }} << 'EOF'
          cd /opt/devops-test
          docker compose pull
          docker compose up -d
          EOF

      # ======================
      # VM-2
      # ======================
      # - name: Setup SSH VM-2
      #   run: |
      #     echo "${{ secrets.SSH_VM2_PRIVATE_KEY }}" > ~/.ssh/id_vm2
      #     chmod 600 ~/.ssh/id_vm2
      #     ssh-keyscan -p ${{ secrets.SSH_VM2_PORT }} \
      #       ${{ secrets.SSH_VM2_HOST }} >> ~/.ssh/known_hosts

      # - name: Deploy to VM-2
      #   run: |
      #     ssh -i ~/.ssh/id_vm2 \
      #       -p ${{ secrets.SSH_VM2_PORT }} \
      #       ${{ secrets.SSH_VM2_USER }}@${{ secrets.SSH_VM2_HOST }} << 'EOF'
      #     cd /opt/devops-test
      #     docker compose pull
      #     docker compose up -d
      #     EOF
